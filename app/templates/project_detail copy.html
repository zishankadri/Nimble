{% extends "_base.html" %} 

{% block title %}Home Page{% endblock %} 

{% block main %} 


    {% if current_project.image %}
        <div class="w-full h-32 bg-repeat" style="background-image: url('{{ url_for('static', filename=current_project.image) }}'); 
                            background-size: 250px 250px;"></div>
        {% else %}
        <p>No image available for this project.</p>
    {% endif %} 

    <div class="px-12 pb-12 text-gray-200">

        <form action="{{ url_for('main.delete_project', id=current_project.id) }}" method="POST" class="mt-4">
            <button type="submit" class="text-gray-400 py-2 rounded hover:text-red-400">
                Delete Project
            </button>
        </form>

        <!-- Top bar -->
        <div class="flex justify-between">
            <input id="projectNameInput"
                class="text-2xl font-bold mb-4 mt-2 mr-4 self-start bg-transparent border-none focus:outline-none"
                value="{{ current_project.name }}"
                onblur="updateProjectName(this.value)"
                onchange="updateProjectName(this.value)"
            />

            <!-- Timer -->
            <div class="flex items-center gap-4">
                <!-- Display the timer -->
                <span id="timerDisplay" class="text-xl font-medium"> {{ current_project.timer_seconds }} </span>

                <!-- Add the timer to your project page -->
                <button id="startTimerBtn" onclick="startTimer()" class="text-4xl text-green-400 hover:text-green-500 aspect-square cursor-pointer">
                    <i class="fa-light fa-circle-play"></i>
                </button>
                <button id="stopTimerBtn" onclick="stopTimer()" class="text-4xl text-green-400 hover:text-green-500 aspect-square cursor-pointer" style="display: none;">
                    <i class="fa-light fa-circle-pause"></i>
                </button>
            </div>

        </div>

        <!-- Task Creation -->
        <form action="{{ url_for('main.create_task', project_id=current_project.id) }}" method="POST" class="mt-6 flex gap-2 items-center">
            <input name="title" placeholder="New Task..." required
                class="regular-input" />
            <button type="submit" class="btn-secondary">
                Add Task
            </button>
        </form>

        <!-- Task List -->
        <div class="mt-6">
            <h3 class="text-xl font-semibold mb-2">Tasks</h3>
            <ul class="space-y-2">
                {% for task in current_project.tasks %}
                <!-- <li class="flex bg-back-600 items-center justify-between p-3 rounded-lg"> -->
                <li class="flex items-center justify-between p-3 rounded-lg {{ 'bg-blue-400/20' if task.highlighted else 'bg-back-600' }}">

                    <span class="{{ 'line-through text-gray-400' if task.completed else '' }}">
                        {{ task.title }}
                    </span>
                    <div class="flex gap-3 items-center">
                        <form action="{{ url_for('main.toggle_highlight', task_id=task.id) }}" method="POST">
                            <button class="text-yellow-400 hover:text-yellow-600 text-sm">
                                {% if task.highlighted %}
                                    <i class="fa-solid fa-bookmark-slash"></i>
                                {% else %}
                                    <i class="fa-light fa-bookmark"></i>
                                {% endif %}
                            </button>
                        </form>

                        <form action="{{ url_for('main.toggle_task', task_id=task.id) }}" method="POST">
                            <button class="text-green-500 hover:text-green-700 text-sm">
                                {{ 'Undo' if task.completed else 'Done' }}
                            </button>
                        </form>
                        <form action="{{ url_for('main.delete_task', task_id=task.id) }}" method="POST">
                            <button class="text-red-400 hover:text-red-600 text-sm">
                                Delete
                            </button>
                        </form>
                    </div>
                </li>
                {% else %}
                <p class="text-gray-400">No tasks yet.</p>
                {% endfor %}
            </ul>
        </div>

    </div>


<!-- Title change -->
<script>
    function updateProjectName(newName) {
        fetch(`/project/{{ current_project.id }}/update_name`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ name: newName })
        }).then(res => {
            if (!res.ok) {
            alert("Project with this name already exists");
            } else {
            document.getElementById("nav-project-name-{{ current_project.id }}").textContent = newName;
            }
        });
    }
</script>

<!-- Timer -->
<script>
    function formatTime(seconds) {
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = seconds % 60;

        if (h > 0) return `${h}h ${m}m ${s}s`;
        if (m > 0) return `${m}m ${s}s`;
        return `${s}s`;
    }

    function updateButtonVisibility(running) {
        document.getElementById("startTimerBtn").style.display = running ? "none" : "inline-block";
        document.getElementById("stopTimerBtn").style.display = running ? "inline-block" : "none";
    }

    let timer = null;
    let syncTimer = null;
    let elapsedTime = 0;
    const display = document.getElementById("timerDisplay");
    const projectId = "{{ current_project.id }}";
    const dbSeconds = {{ current_project.timer_seconds | default(0) }};  // From server

    function loadTimerState() {
        const stored = JSON.parse(localStorage.getItem("activeTimer"));
        if (stored && stored.id === projectId) {
        const now = Date.now();
        const offset = Math.floor((now - stored.startTime) / 1000);
        elapsedTime = stored.initialSeconds + offset;
        display.textContent = formatTime(elapsedTime);
        startInterval();
        startSync();
        updateButtonVisibility(true);
        } else {
        elapsedTime = dbSeconds;
        display.textContent = formatTime(elapsedTime);
        updateButtonVisibility(false);
        }
    }

    function startInterval() {
        clearInterval(timer);
        timer = setInterval(() => {
        elapsedTime++;
        display.textContent = formatTime(elapsedTime);
        }, 1000);
    }

    function startSync() {
        clearInterval(syncTimer);
        syncTimer = setInterval(() => {
        fetch(`/project/${projectId}/sync_timer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seconds: elapsedTime })
        });
        }, 10000);
    }

    function startTimer() {
        const current = JSON.parse(localStorage.getItem("activeTimer"));

        // Sync and stop previous timer if it's from another project
        if (current && current.id !== projectId) {
        const now = Date.now();
        const finalElapsed = Math.floor((now - current.startTime) / 1000) + current.initialSeconds;

        fetch(`/project/${current.id}/sync_timer`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ seconds: finalElapsed })
        });

        localStorage.removeItem("activeTimer");
        }

        const startTime = Date.now();
        localStorage.setItem("activeTimer", JSON.stringify({
        id: projectId,
        startTime,
        initialSeconds: elapsedTime
        }));
        startInterval();
        startSync();
        updateButtonVisibility(true);

    }

    function stopTimer() {
        clearInterval(timer);
        clearInterval(syncTimer);
        localStorage.removeItem("activeTimer");

        fetch(`/project/${projectId}/sync_timer`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ seconds: elapsedTime })
        });
        updateButtonVisibility(false);

    }

    window.onload = loadTimerState;
</script>


{% endblock %}