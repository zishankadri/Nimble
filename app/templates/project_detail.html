{% extends "_base.html" %} 

{% block title %}Home Page{% endblock %} 

{% block main %} 


    {% if current_project.image %}
        <div class="w-full h-32 bg-repeat" style="background-image: url('{{ url_for('static', filename=current_project.image) }}'); 
                            background-size: 250px 250px;"></div>
        {% else %}
        <p>No image available for this project.</p>
    {% endif %} 

    <div class="px-12 pb-12 text-gray-200">

        <div class="relative w-full flex justify-end my-2">

            <button type="button" class="aspect-square rounded-full w-8 text-gray-400 hover:bg-back-600 focus:outline-none flex items-center justify-center" id="dropdownMenuButton" onclick="toggleDropdown()">
                <i class="fa-solid fa-ellipsis-vertical text-xl"></i>
            </button>
            <div id="dropdownMenu" class="bg-back-600 origin-top-right absolute right-0 mt-8 mr-4 w-56 rounded-md shadow-2xl z-10 hidden">
                <div class="py-1">
                    <form action="{{ url_for('main.delete_project', id=current_project.id) }}" method="POST">
                        <button type="submit" class="block w-full text-left px-4 py-2 text-gray-400 hover:text-red-400 hover:bg-back-600">
                            <i class="fa-regular fa-trash-xmark text-sm pr-2"></i> Delete project
                        </button>
                    </form>
                    <form action="{{ url_for('main.delete_project', id=current_project.id) }}" method="POST">
                        <button type="submit" class="block w-full text-left px-4 py-2 text-gray-400 hover:text-green-400 hover:bg-back-600">
                            <i class="fa-regular fa-circle-check text-sm pr-2"></i> Mark as complete
                        </button>
                    </form>
                </div>
            </div>
        </div>
        <script>
            function toggleDropdown() {
                const menu = document.getElementById('dropdownMenu');
                menu.classList.toggle('hidden');
            }
            // Optional: Hide dropdown when clicking outside
            document.addEventListener('click', function(event) {
                const button = document.getElementById('dropdownMenuButton');
                const menu = document.getElementById('dropdownMenu');
                if (!button.contains(event.target) && !menu.contains(event.target)) {
                    menu.classList.add('hidden');
                }
            });
        </script>

        <!-- Top bar -->
        <div class="flex justify-between">
            <input id="projectNameInput"
                class="text-2xl font-bold mb-4 mt-2 mr-4 self-start bg-transparent border-none focus:outline-none"
                value="{{ current_project.name }}"
                onblur="updateProjectName(this.value)"
                onchange="updateProjectName(this.value)"
            />

            <!-- Timer -->
            <div class="flex items-center gap-4">
                <!-- Display the timer -->
                <span id="timerDisplay" class="text-xl font-medium">
                     {{ current_project.timer_seconds | default(0) | format_seconds }} 
                </span>

                <!-- Add the timer to your project page -->
                <button id="startTimerBtn" onclick="startTimer()" class="text-4xl text-green-400 hover:text-green-500 aspect-square cursor-pointer">
                    <i class="fa-light fa-circle-play"></i>
                </button>
                <button id="stopTimerBtn" onclick="stopTimer()" class="text-4xl text-green-400 hover:text-green-500 aspect-square cursor-pointer" style="display: none;">
                    <i class="fa-light fa-circle-pause"></i>
                </button>
            </div>

        </div>

        <!-- Task Creation -->
        <form action="{{ url_for('main.create_task', project_id=current_project.id) }}" method="POST" class="mt-6 flex gap-2 items-center">
            <input name="title" placeholder="New Task..." required
                class="regular-input" />
            <button type="submit" class="btn-secondary">
                Add Task
            </button>
        </form>

        <!-- Task List -->
        <div class="mt-6">
            <h3 class="text-xl font-semibold mb-2">Tasks</h3>
            <ul class="space-y-2">
                {% for task in current_project.tasks %}
                <!-- <li class="flex bg-back-600 items-center justify-between p-3 rounded-lg"> -->
                <li class="flex items-center justify-between p-3 rounded-lg {{ 'bg-blue-400/20' if task.highlighted else 'bg-back-600' }}">

                    <span class="{{ 'line-through text-gray-400' if task.completed else '' }}">
                        {{ task.title }}
                    </span>
                    <div class="flex gap-3 items-center">
                        <form action="{{ url_for('main.toggle_highlight', task_id=task.id) }}" method="POST">
                            <button class="text-yellow-400 hover:text-yellow-600 text-sm">
                                {% if task.highlighted %}
                                    <i class="fa-solid fa-bookmark-slash"></i>
                                {% else %}
                                    <i class="fa-light fa-bookmark"></i>
                                {% endif %}
                            </button>
                        </form>

                        <form action="{{ url_for('main.toggle_task', task_id=task.id) }}" method="POST">
                            <button class="text-green-500 hover:text-green-700 text-sm">
                                {{ 'Undo' if task.completed else 'Done' }}
                            </button>
                        </form>
                        <form action="{{ url_for('main.delete_task', task_id=task.id) }}" method="POST">
                            <button class="text-red-400 hover:text-red-600 text-sm">
                                Delete
                            </button>
                        </form>
                    </div>
                </li>
                {% else %}
                <p class="text-gray-400">No tasks yet.</p>
                {% endfor %}
            </ul>
        </div>

    </div>


<script>
let interval = null;

function updateProjectName(newName) {
    fetch(`/project/{{ current_project.id }}/update_name`, {
        method: "POST",
        headers: {
            "Content-Type": "application/json"
        },
        body: JSON.stringify({ name: newName })
    })
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert("Error: " + data.error);
        } else {
            // Update the sidebar nav project name immediately
            const navName = document.getElementById("nav-project-name-{{ current_project.id }}");
            if (navName) {
                navName.textContent = newName;
            }
        }
    })
    .catch(error => {
        alert("Failed to update project name.");
        console.error(error);
    });
}

function updateButtonVisibility(running) {
    document.getElementById("startTimerBtn").style.display = running ? "none" : "inline-block";
    document.getElementById("stopTimerBtn").style.display = running ? "inline-block" : "none";
}

function formatTime(seconds) {
    const h = Math.floor(seconds / 3600);
    const m = Math.floor((seconds % 3600) / 60);
    const s = seconds % 60;
    // Pad with leading zeros if less than 10 for minutes and seconds when hours are present
    const formattedM = (h > 0 && m < 10) ? `0${m}` : m;
    const formattedS = (s < 10) ? `0${s}` : s;

    if (h > 0) return `${h}h ${formattedM}m ${formattedS}s`;
    if (m > 0) return `${m}m ${formattedS}s`;
    return `${s}s`; // No padding for seconds alone as it's typically just a number
}

function fetchAndUpdateTimer() {
    fetch(`/project/{{ current_project.id }}/get_timer`)
        .then(res => res.json())
        .then(data => {
            document.getElementById("timerDisplay").textContent = formatTime(data.seconds);

            // ALWAYS update button visibility based on the server's state
            updateButtonVisibility(data.running);

            if (data.running && !interval) {
                // Only start the interval if the server says it's running AND
                // our local interval isn't already active.
                startInterval();
            } else if (!data.running && interval) {
                // If server says it's not running, but our local interval is, stop it.
                // This handles cases where another tab/user stops the timer.
                clearInterval(interval);
                interval = null;
            }
        });
}

function startTimer() {
    fetch(`/project/{{ current_project.id }}/start_timer`, { method: "POST" })
        .then(() => { // Optional: Chain a .then() to ensure server responded before updating
            startInterval();
            updateButtonVisibility(true);
        })
        .catch(error => console.error('Error starting timer:', error));
}

function stopTimer() {
    fetch(`/project/{{ current_project.id }}/stop_timer`, { method: "POST" })
        .then(() => { // Optional: Chain a .then()
            clearInterval(interval);
            interval = null;
            updateButtonVisibility(false);
        })
        .catch(error => console.error('Error stopping timer:', error));
}

function startInterval() {
    if (interval) return; // Prevent multiple intervals
    interval = setInterval(fetchAndUpdateTimer, 1000);
}

// Call fetchAndUpdateTimer immediately when the window loads to set initial state
window.onload = fetchAndUpdateTimer;
</script>


{% endblock %}